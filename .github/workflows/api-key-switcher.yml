name: Build API Key Switcher

on:
  push:
    branches: [master]
    paths:
      - 'client/**'
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [master]
    paths:
      - 'client/**'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    defaults:
      run:
        working-directory: client

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Package application
        run: npm run package

      - name: Get version info
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            VERSION=$(node -p "require('./package.json').version")
            COMMIT_SHORT=$(git rev-parse --short HEAD)
            echo "version=$VERSION-dev.$COMMIT_SHORT" >> $GITHUB_OUTPUT
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: API-Key-Switcher-Windows-${{ steps.version.outputs.version }}
          path: client/release/*.exe

      - name: Update Latest Release (Dev Build)
        if: github.ref == 'refs/heads/master' && steps.version.outputs.is_release == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: API Key Switcher - Latest Build (Dev)
          body: |
            ğŸš§ **å¼€å‘ç‰ˆæœ¬ - è‡ªåŠ¨æ„å»º**
            
            è¿™æ˜¯æœ€æ–°çš„å¼€å‘ç‰ˆæœ¬ï¼Œå¯èƒ½ä¸ç¨³å®šã€‚å¦‚éœ€ç¨³å®šç‰ˆæœ¬ï¼Œè¯·æŸ¥çœ‹æ­£å¼å‘å¸ƒç‰ˆæœ¬ã€‚
            
            **ç‰ˆæœ¬ä¿¡æ¯ï¼š**
            - ç‰ˆæœ¬å·: ${{ steps.version.outputs.version }}
            - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
            - æäº¤: ${{ github.sha }}
            - æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}
          files: client/release/*.exe
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Version Release
        if: startsWith(github.ref, 'refs/tags/v') && steps.version.outputs.is_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: API Key Switcher v${{ steps.version.outputs.version }}
          body: |
            ## ğŸ‰ API Key Switcher v${{ steps.version.outputs.version }}
            
            ### ğŸ“¦ ä¸‹è½½
            è¯·ä¸‹è½½ä¸‹æ–¹çš„ `API-Key-Switcher.exe` æ–‡ä»¶
            
            ### ğŸ“ æ›´æ–°å†…å®¹
            è¯·åœ¨æ­¤å¤„æ·»åŠ ç‰ˆæœ¬æ›´æ–°è¯´æ˜
            
            ### ğŸ”— ç›¸å…³é“¾æ¥
            - [å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/releases)
            - [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)
          files: client/release/*.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
