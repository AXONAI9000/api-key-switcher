# API Key Switcher 同步功能安全说明

## 加密架构

### 加密算法

- **对称加密**：AES-256-GCM
- **密钥派生**：PBKDF2-SHA256（100,000 次迭代）
- **校验和**：SHA-256

### 加密流程

```
用户密码 → PBKDF2 → 加密密钥
                      ↓
配置数据 → AES-256-GCM 加密 → 加密数据包
                      ↓
              上传到服务器
```

### 数据包结构

```json
{
  "encryptedData": "Base64 编码的加密数据",
  "iv": "Base64 编码的初始化向量（12 字节）",
  "salt": "Base64 编码的盐值（32 字节）",
  "checksum": "原始数据的 SHA-256 校验和",
  "version": 1,
  "timestamp": "ISO 8601 时间戳",
  "deviceId": "设备唯一标识"
}
```

## 零知识存储

服务器只存储加密后的数据包，无法：

1. 解密配置内容
2. 获取您的 API Key
3. 知道您使用了哪些服务商

## 密钥管理

### 主密码

- 主密码不会离开您的设备
- 不会以任何形式上传到服务器
- 用于派生加密密钥

### 密钥派生

使用 PBKDF2 从主密码派生加密密钥：

- 迭代次数：100,000
- 输出长度：256 位
- 哈希算法：SHA-256
- 随机盐值：每次加密生成新盐值

## 传输安全

### 建议配置

1. **始终使用 HTTPS**
2. 验证服务器证书
3. 使用强访问令牌

### 访问令牌

- 用于服务器认证
- 建议使用随机生成的长字符串
- 定期轮换

## 威胁模型

### 防护范围

| 威胁 | 防护措施 |
|------|----------|
| 服务器数据泄露 | 端到端加密 |
| 中间人攻击 | HTTPS + 证书验证 |
| 暴力破解 | PBKDF2 高迭代次数 |
| 数据篡改 | SHA-256 校验和 |
| 重放攻击 | 时间戳 + 设备 ID |

### 不在防护范围

| 威胁 | 说明 |
|------|------|
| 本地设备被入侵 | 攻击者可直接读取内存中的密钥 |
| 弱主密码 | 可能被字典攻击破解 |
| 社会工程 | 用户主动泄露密码 |

## 最佳实践

### 密码选择

1. 至少 12 个字符
2. 包含大小写字母、数字、特殊字符
3. 不要使用常见词汇或个人信息
4. 不要在其他地方重复使用

### 服务器部署

1. 使用 HTTPS（Let's Encrypt 免费证书）
2. 配置防火墙，只开放必要端口
3. 定期更新系统和依赖
4. 启用访问日志

### 日常使用

1. 定期备份配置（导出功能）
2. 不要在公共网络上同步敏感数据
3. 定期检查同步状态
4. 发现异常立即更换访问令牌

## 审计日志

服务器记录以下信息（不包含敏感数据）：

- 请求时间
- 请求类型（状态/拉取/推送）
- Token 哈希（用于识别用户）
- 请求结果

## 数据删除

### 客户端

删除 `~/.api-key-switcher/` 目录下的：
- `sync-config.json`
- `master-password.json`

### 服务器

数据存储在 `data/` 目录，文件名为 Token 的 SHA-256 哈希。

## 合规性

本同步功能设计符合以下原则：

- **数据最小化**：只存储必要数据
- **加密存储**：所有敏感数据加密
- **用户控制**：用户可随时删除数据
- **透明性**：开源代码，可审计

## 漏洞报告

如发现安全漏洞，请通过以下方式报告：

1. 不要公开披露
2. 提供详细的复现步骤
3. 等待修复后再公开

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| 1.0 | 2024-01 | 初始版本 |
